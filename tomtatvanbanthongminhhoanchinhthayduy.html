<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tr·ª£ L√Ω VƒÉn B·∫£n H√†nh Ch√≠nh</title>
  <!-- ‚úÖ ƒê√É S·ª¨A: X√ìA TO√ÄN B·ªò KHO·∫¢NG TR·∫ÆNG TH·ª™A TRONG URL -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://unpkg.com/docx@7.4.1/build/index.js"></script>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #c7d2fe;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    body {
      background: linear-gradient(135deg, var(--bg), #e0e7ff);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .subtitle {
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 24px;
    }
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .upload-area:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    .file-input {
      display: none;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      resize: vertical;
      margin-bottom: 16px;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #4338ca;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .summary-output {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 10px;
      margin-top: 16px;
      min-height: 100px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .footer-note {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 30px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Tr·ª£ L√Ω VƒÉn B·∫£n H√†nh Ch√≠nh
      </h1>
      <p class="subtitle">T·∫£i l√™n vƒÉn b·∫£n h√†nh ch√≠nh ‚Äî h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông tr√≠ch xu·∫•t th√¥ng tin v√† ƒë·ªÅ m·ª•c ch√≠nh...</p>
    </header>

    <main>
      <div class="card">
        <div class="upload-area" id="dropArea">
          <p>üìÑ K√©o th·∫£ file Word/PDF v√†o ƒë√¢y</p>
          <p style="font-size:0.9rem;color:#64748b;margin-top:6px">H·ªó tr·ª£: .txt, .docx, .pdf</p>
          <input type="file" id="fileInput" class="file-input" accept=".txt,.docx,.pdf" />
        </div>

        <label for="textInput">VƒÉn b·∫£n g·ªëc:</label>
        <textarea id="textInput" placeholder="Ho·∫∑c d√°n vƒÉn b·∫£n v√†o ƒë√¢y..."></textarea>

        <label for="instructionInput">Y√™u c·∫ßu x·ª≠ l√Ω:</label>
        <textarea id="instructionInput" placeholder="V√≠ d·ª•: 'L·∫•y s·ªë, ng√†y k√Ω, ti√™u ƒë·ªÅ, n·ªôi dung ch√≠nh v√† c√°c ƒë·ªÅ m·ª•c'">L·∫•y s·ªë, ng√†y k√Ω, ti√™u ƒë·ªÅ, n·ªôi dung ch√≠nh v√† c√°c ƒë·ªÅ m·ª•c</textarea>

        <button id="processBtn" style="width:100%;">
          <span id="btnText">X·ª≠ L√Ω VƒÉn B·∫£n</span>
        </button>
      </div>

      <div class="card" id="resultCard" style="display:none;">
        <h3>K·∫øt Qu·∫£ X·ª≠ L√Ω</h3>
        <div class="summary-output" id="summaryOutput"></div>
        <div class="actions">
          <button id="downloadWordBtn" class="btn-outline">
            T·∫£i xu·ªëng Word (.docx)
          </button>
          <button id="downloadPdfBtn" class="btn-outline">
            T·∫£i xu·ªëng PDF
          </button>
        </div>
      </div>
    </main>

    <div class="footer-note">
      üí° ·ª®ng d·ª•ng n√†y s·ª≠ d·ª•ng regex ƒë·ªÉ tr√≠ch xu·∫•t th√¥ng tin ‚Äî ph√π h·ª£p v·ªõi vƒÉn b·∫£n h√†nh ch√≠nh chu·∫©n.
    </div>
  </div>

  <script>
    // ‚úÖ S·ª¨A: X√ìA KHO·∫¢NG TR·∫ÆNG TRONG WORKER SRC
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const textInput = document.getElementById('textInput');
    const instructionInput = document.getElementById('instructionInput');
    const dropArea = document.getElementById('dropArea');
    const processBtn = document.getElementById('processBtn');
    const btnText = document.getElementById('btnText');
    const resultCard = document.getElementById('resultCard');
    const summaryOutput = document.getElementById('summaryOutput');
    const downloadWordBtn = document.getElementById('downloadWordBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    let currentText = '';

    // X·ª≠ l√Ω k√©o th·∫£
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropArea.style.borderColor = '#4f46e5';
      dropArea.style.backgroundColor = '#c7d2fe';
    }

    function unhighlight() {
      dropArea.style.borderColor = '#cbd5e1';
      dropArea.style.backgroundColor = 'transparent';
    }

    dropArea.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length) {
        processFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length) {
        processFile(files[0]);
      }
    }

    function processFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      if (ext === 'txt') {
        reader.onload = function(e) {
          textInput.value = e.target.result;
          currentText = e.target.result;
        };
        reader.readAsText(file);
      } else if (ext === 'docx') {
        reader.onload = async function(e) {
          try {
            const arrayBuffer = e.target.result;
            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
            textInput.value = result.value;
            currentText = result.value;
          } catch (err) {
            alert('Kh√¥ng th·ªÉ ƒë·ªçc file Word: ' + err.message);
          }
        };
        reader.readAsArrayBuffer(file);
      } else if (ext === 'pdf') {
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + ' ';
            }
            textInput.value = fullText;
            currentText = fullText;
          } catch (err) {
            alert('Kh√¥ng th·ªÉ ƒë·ªçc file PDF: ' + err.message);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert('ƒê·ªãnh d·∫°ng file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.');
      }
    }

    // Tr√≠ch xu·∫•t ƒë·ªÅ m·ª•c ch√≠nh
    function extractHeadings(text) {
      const lines = text.split('\n').filter(line => line.trim().length > 0);
      const headings = [];
      
      const headingPatterns = [
        /^[IVX]+\.\s+[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆Ø·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥·ª∂·ª∏]/,
        /^\d+\.\s+[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆Ø·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥·ª∂·ª∏]/,
        /^[a-z]\)\s+[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆Ø·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥·ª∂·ª∏]/,
        /^Ch∆∞∆°ng\s+\d+/i,
        /^M·ª•c\s+[IVX\d]+/i
      ];

      for (const line of lines) {
        const cleanLine = line.trim();
        if (cleanLine.length > 10) {
          for (const pattern of headingPatterns) {
            if (pattern.test(cleanLine)) {
              headings.push(cleanLine);
              break;
            }
          }
        }
      }
      
      return headings;
    }

    function extractOfficialDocumentInfo(text) {
      const result = {
        soVanBan: "",
        ngayKy: "",
        noiKy: "",
        nguoiKy: "",
        tieuDe: "",
        noiDungChinh: "",
        deMucChinh: []
      };

      const soRegex = /(S·ªê|S·ªë|s·ªë)\s*[:\s]\s*([^\n\r]+?)(?=\n|$)/i;
      const soMatch = text.match(soRegex);
      if (soMatch) result.soVanBan = soMatch[2].trim();

      const dateRegex = /(Ng√†y|ng√†y)\s+(\d{1,2})\s+(th√°ng|Th√°ng)\s+(\d{1,2})\s+(nƒÉm|NƒÉm)\s+(\d{4})/i;
      const dateMatch = text.match(dateRegex);
      if (dateMatch) result.ngayKy = `${dateMatch[2]} th√°ng ${dateMatch[4]} nƒÉm ${dateMatch[6]}`;

      const noiKyRegex = /(T·∫°i|t·∫°i|·ªû|·ªü|ƒê·ªãa ƒëi·ªÉm|ƒë·ªãa ƒëi·ªÉm)\s+([^\n\r.]+)/i;
      const noiKyMatch = text.match(noiKyRegex);
      if (noiKyMatch) result.noiKy = noiKyMatch[2].trim();

      const nguoiKyRegex = /(Ng∆∞·ªùi k√Ω|k√Ω b·ªüi|Ch·ªß t·ªãch|Tr∆∞·ªüng ban|Ph√≥ ch·ªß t·ªãch|Ph√≥ tr∆∞·ªüng ban|B√≠ th∆∞|Ph√≥ b√≠ th∆∞|·ª¶y ban nh√¢n d√¢n|ƒê·∫£ng ·ªßy)\s*[:\s]\s*([^\n\r]+)/i;
      const nguoiKyMatch = text.match(nguoiKyRegex);
      if (nguoiKyMatch) result.nguoiKy = nguoiKyMatch[2].trim();

      const lines = text.split(/\n+/).filter(line => line.trim().length > 0);
      if (lines.length > 0) {
        let bestTitle = lines[0].trim();
        let maxUppercaseRatio = 0;
        for (const line of lines) {
          const cleanLine = line.trim();
          if (cleanLine.length < 10) continue;
          const uppercaseCount = (cleanLine.match(/[A-Z√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†∆Ø·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÇ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ª¨·ªÆ·ª∞·ª≤·ª¥·ª∂·ª∏]/g) || []).length;
          const ratio = uppercaseCount / cleanLine.length;
          if (ratio > maxUppercaseRatio && ratio > 0.3) {
            maxUppercaseRatio = ratio;
            bestTitle = cleanLine;
          }
        }
        result.tieuDe = bestTitle;
      }

      const sentences = text.replace(/\n+/g, ' ').split(/[.!?]+/).filter(s => s.trim().length > 20);
      if (sentences.length >= 2) {
        result.noiDungChinh = sentences.slice(0, 2).map(s => s.trim()).join('. ') + '.';
      } else if (sentences.length === 1) {
        result.noiDungChinh = sentences[0].trim() + '.';
      } else {
        result.noiDungChinh = text.substring(0, 150) + '...';
      }

      result.deMucChinh = extractHeadings(text);
      return result;
    }

    processBtn.addEventListener('click', () => {
      const input = textInput.value || currentText;
      if (!input.trim()) {
        alert('Vui l√≤ng nh·∫≠p ho·∫∑c t·∫£i l√™n vƒÉn b·∫£n tr∆∞·ªõc.');
        return;
      }

      processBtn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';

      setTimeout(() => {
        const info = extractOfficialDocumentInfo(input);
        
        let output = "";
        if (info.soVanBan) output += `S·ªë: ${info.soVanBan}\n`;
        if (info.ngayKy) output += `Ng√†y k√Ω: ${info.ngayKy}\n`;
        if (info.noiKy) output += `N∆°i k√Ω: ${info.noiKy}\n`;
        if (info.nguoiKy) output += `Ng∆∞·ªùi k√Ω: ${info.nguoiKy}\n`;
        if (info.tieuDe) output += `\nTi√™u ƒë·ªÅ: ${info.tieuDe}\n`;
        if (info.noiDungChinh) output += `\nN·ªôi dung ch√≠nh:\n${info.noiDungChinh}\n`;
        if (info.deMucChinh.length > 0) {
          output += `\nC√°c ƒë·ªÅ m·ª•c ch√≠nh:\n`;
          info.deMucChinh.forEach((item, index) => {
            output += `${index + 1}. ${item}\n`;
          });
        }

        summaryOutput.textContent = output;
        resultCard.style.display = 'block';
        processBtn.disabled = false;
        btnText.textContent = 'X·ª≠ L√Ω L·∫°i';
      }, 800);
    });

    // ‚úÖ C∆† CH·∫æ D·ª∞ PH√íNG CHO WORD EXPORT
    downloadWordBtn.addEventListener('click', () => {
      const content = summaryOutput.textContent;
      if (!content) return;

      // Th·ª≠ t·∫°o file Word
      try {
        const { Document, Paragraph, TextRun, Packer } = window.docx;
        const doc = new Document({
          sections: [{
            properties: {},
            children: [new Paragraph({ children: [new TextRun(content)] })]
          }]
        });

        Packer.toBlob(doc).then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ket-qua-xu-ly-van-ban.docx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }).catch(err => {
          console.error('Word export failed:', err);
          fallbackToTextDownload(content, 'ket-qua-xu-ly-van-ban.txt');
        });
      } catch (err) {
        console.error('Word creation failed:', err);
        fallbackToTextDownload(content, 'ket-qua-xu-ly-van-ban.txt');
      }
    });

    // ‚úÖ C∆† CH·∫æ D·ª∞ PH√íNG CHO PDF EXPORT
    downloadPdfBtn.addEventListener('click', () => {
      const content = summaryOutput.textContent;
      if (!content) return;

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const lines = doc.splitTextToSize(content, 180);
        doc.text(lines, 15, 20);
        doc.save("ket-qua-xu-ly-van-ban.pdf");
      } catch (err) {
        console.error('PDF export failed:', err);
        fallbackToTextDownload(content, 'ket-qua-xu-ly-van-ban.txt');
      }
    });

    // ‚úÖ H√ÄM D·ª∞ PH√íNG: T·∫¢I XU·ªêNG FILE VƒÇN B·∫¢N TH√î
    function fallbackToTextDownload(content, filename) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert(`ƒê√£ t·∫£i xu·ªëng file vƒÉn b·∫£n th√¥: ${filename}`);
    }
  </script>
</body>
</html>

